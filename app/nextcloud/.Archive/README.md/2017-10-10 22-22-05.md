## [原创]使用Nextcloud提供私有网盘服务

本文原创：**南京审计大学 吴鑫**

修改时间：2017.10.10

## 一、Why Nextcloud？
假设你想在校内搭建一个私有云盘服务，并且有以下的需求，那么`Nextcloud`，简称`NC`是你的不二之选
- 没有资金的投入，但是有相应的需求；
- 需要部署在私有云上；
- 有多客户端要求（iOS、Android、MAC、Windows）
- 安全可靠，长期更新
- 有和现有系统（例如`LDAP`集成需求）



## 二、环境准备
在开始之前，请确定你已经准备好以下条件：
- `VMWare`环境的虚拟机（本文以VMWare为例，其他也可以）
- 一定的存储空间
- 数据中心有一台`DHCP`服务器，服务器可以上网
- 一定的`Ubuntu`基础知识
- 一颗不怕折腾的心，一个支持你工作的领导

##三、安装
- 到`NC`官网，选择`20G`的镜像并下载，地址：`https://www.techandme.se/nextcloud-vm/`，可以多测几次，我使用的是澳大利亚镜像。相对较快。
- 压缩包中为`VMDK`文件，请使用`VMWare vCenter Converter`转换。具体使用方法本文跳过。
- 转换完成后，启动，默认账号为`ncadmin`，密码为`nextcloud`
- 随后检测网络，注意网络需要`提前准备好`DHCP才行。配置过程里会让你设置静态IP。
- 安装过程会通过ping网关来确定网络是否可达。请确保网关可ping。
- 然后他会自己找镜像，等一会就行了。
- 需要注意的是，如果没有DHCP，这个OVF似乎无法判断你所在的位置，默认的键位就是瑞典的，`/`会变成`-`，需要使用`sudo dpkg-reconfigure keyboard-configuration`命令重新配置键盘

安装脚本的主要工作如下：

![](./_image/1485678471943.png)

##四、其他常见问题
###关于扩容
##扩容
我们使用的默认nextcloud的vm只有20G，1TB和500g的要$才行。

扩容可以参考这里：
`https://www.techandme.se/not-enough-space/`

- 关机，做一个备份（快照）
- 编辑磁盘空间为1.5T。
- 开机
- `sudo -i`
- `echo "- - -" > /sys/class/scsi_host/host0/scan`，扫描
- `cfdisk /dev/sda`，
- cfdisk创建分区（移动到`new`）
- 选择Logic，Type选择Linux8E(LVM)，最后write

- 扫描，`partprobe -s`
- 看看当前是是sda几，`fdisk -l`
- 格式化：`mkfs.ext4 /dev/sda6`
- `pvcreate /dev/sda6`，创建pv
- `vgextend nextcloud-vg /dev/sda6`，扩展vg
- `lvextend -L+XXG /dev/nextcloud-vg/root`，扩展lv
- `resize2fs /dev/nextcloud-vg/root`
- `sudo reboot`
- `df -h`


##五、关于SSL

